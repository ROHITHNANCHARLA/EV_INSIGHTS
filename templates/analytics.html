{% extends "layout.html" %}
{% block body %}

<div class="container-fluid">
  <h2 class="page-title mb-3">üìä Advanced Analytics Explorer</h2>

  <!-- üîç Filter Panel -->
  <div class="card panel p-4 mb-4 fade-in">
    <form id="filterForm" class="row g-3 align-items-end">
      <div class="col-md-3">
        <label class="form-label">Select Year</label>
        <select id="f_year" class="form-select">
          <option value="">All Years</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Select State</label>
        <select id="f_state" class="form-select">
          <option value="">All States</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Vehicle Type</label>
        <select id="f_type" class="form-select">
          <option value="">All Types</option>
        </select>
      </div>
      <div class="col-md-3 text-end">
        <button id="apply" class="btn btn-cta w-100">üîé Apply Filters</button>
      </div>
    </form>
  </div>

  <!-- ‚úÖ KPI Cards -->
  <div class="row text-center mb-4 fade-up">
    <div class="col-md-3">
      <div class="card panel p-3 shadow-sm">
        <h4 id="kpi_total" class="text-primary mb-1">0</h4>
        <small>Total Units Sold</small>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card panel p-3 shadow-sm">
        <h4 id="kpi_rows" class="text-primary mb-1">0</h4>
        <small>Records Matched</small>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card panel p-3 shadow-sm">
        <h4 id="kpi_state" class="text-primary mb-1">-</h4>
        <small>Top State</small>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card panel p-3 shadow-sm">
        <h4 id="kpi_type" class="text-primary mb-1">-</h4>
        <small>Top Vehicle Type</small>
      </div>
    </div>
  </div>

  <!-- üîπ Visualization Row -->
  <div class="row g-4 fade-in">
    <div class="col-lg-6">
      <div class="card panel p-3">
        <h5 class="accent mb-2">üìà Sales by State</h5>
        <div id="chart_state" style="height:320px;"></div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card panel p-3">
        <h5 class="accent mb-2">üöò Sales by Vehicle Type</h5>
        <div id="chart_type" style="height:320px;"></div>
      </div>
    </div>
  </div>

  <!-- üîπ Second Visualization Row -->
  <div class="row g-4 mt-2 fade-in">
    <div class="col-lg-6">
      <div class="card panel p-3">
        <h5 class="accent mb-2">üè≠ Manufacturer Performance</h5>
        <div id="chart_manufacturer" style="height:320px;"></div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card panel p-3">
        <h5 class="accent mb-2">üìÖ Monthly Trend</h5>
        <div id="chart_month" style="height:320px;"></div>
      </div>
    </div>
  </div>

  <!-- üîπ Data Table -->
  <div class="card panel p-3 mt-4 fade-up">
    <h5 class="accent mb-3">üìã Filtered Data Summary</h5>
    <div id="table" class="table-responsive"></div>
  </div>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
async function loadOptions() {
  const res = await fetch('/api/options');
  const data = await res.json();

  const yearSel = document.getElementById('f_year');
  const stateSel = document.getElementById('f_state');
  const typeSel = document.getElementById('f_type');

  yearSel.innerHTML = '<option value="">All Years</option>';
  data.years.forEach(y => yearSel.innerHTML += `<option value="${y}">${y}</option>`);

  stateSel.innerHTML = '<option value="">All States</option>';
  data.states.forEach(s => stateSel.innerHTML += `<option value="${s}">${s}</option>`);

  typeSel.innerHTML = '<option value="">All Types</option>';
  data.vehicle_types.forEach(t => typeSel.innerHTML += `<option value="${t}">${t}</option>`);
}

loadOptions();

// Animate KPI count-up
function animateValue(id, start, end, duration) {
  const el = document.getElementById(id);
  let startTime = null;

  function update(currentTime) {
    if (!startTime) startTime = currentTime;
    const progress = Math.min((currentTime - startTime) / duration, 1);
    el.innerText = Math.floor(progress * (end - start) + start).toLocaleString();
    if (progress < 1) requestAnimationFrame(update);
  }
  requestAnimationFrame(update);
}

// Apply filter and visualize
document.getElementById('apply').addEventListener('click', async (e) => {
  e.preventDefault();
  const payload = {
    year: document.getElementById('f_year').value,
    state: document.getElementById('f_state').value,
    vehicle_type: document.getElementById('f_type').value
  };

  const res = await fetch('/api/filter', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  const d = await res.json();

  if (!d.kpi || d.kpi.rows === 0) {
    document.getElementById('table').innerHTML = "<p class='text-muted'>No records found for the selected filters.</p>";
    return;
  }

  // KPI Updates with animation
  animateValue('kpi_total', 0, d.kpi.total_units, 1200);
  animateValue('kpi_rows', 0, d.kpi.rows, 800);
  document.getElementById('kpi_state').innerText = d.kpi.top_state || '-';
  document.getElementById('kpi_type').innerText = d.kpi.top_type || '-';

  // Charts
  Plotly.newPlot('chart_state', [{
    x: d.charts.by_state.map(r=>r.EV_Sales_Quantity),
    y: d.charts.by_state.map(r=>r.State),
    orientation:'h',
    type:'bar',
    marker:{color:'#00eaff'}
  }], {margin:{l:100,t:20}, paper_bgcolor:'transparent', plot_bgcolor:'transparent'});

  Plotly.newPlot('chart_type', [{
    labels: d.charts.by_type.map(r=>r.Vehicle_Type),
    values: d.charts.by_type.map(r=>r.EV_Sales_Quantity),
    type:'pie', hole:0.45
  }], {margin:{t:20}, paper_bgcolor:'transparent'});

  Plotly.newPlot('chart_manufacturer', [{
    x: d.charts.by_manufacturer.map(r=>r.Manufacturer),
    y: d.charts.by_manufacturer.map(r=>r.EV_Sales_Quantity),
    type:'bar', marker:{color:'#0077ff'}
  }], {margin:{t:20}, paper_bgcolor:'transparent', plot_bgcolor:'transparent'});

  Plotly.newPlot('chart_month', [{
    x: d.charts.by_month.map(r=>r.Month_Name),
    y: d.charts.by_month.map(r=>r.EV_Sales_Quantity),
    mode:'lines+markers', type:'scatter', line:{color:'#00bfff', width:3}
  }], {margin:{t:20}, paper_bgcolor:'transparent', plot_bgcolor:'transparent'});

  // Table
  let html = `<table class="table table-dark table-striped">
    <thead><tr>
      <th>Year</th><th>State</th><th>Manufacturer</th>
      <th>Vehicle Type</th><th>Model</th><th>Units</th>
    </tr></thead><tbody>`;
  d.table.forEach(r=>{
    html += `<tr>
      <td>${r.Year}</td>
      <td>${r.State}</td>
      <td>${r.Manufacturer}</td>
      <td>${r.Vehicle_Type}</td>
      <td>${r.Model}</td>
      <td>${(+r.EV_Sales_Quantity).toLocaleString()}</td>
    </tr>`;
  });
  html += '</tbody></table>';
  document.getElementById('table').innerHTML = html;
});

// Load defaults
window.addEventListener('load', ()=>document.getElementById('apply').click());
</script>

{% endblock %}
